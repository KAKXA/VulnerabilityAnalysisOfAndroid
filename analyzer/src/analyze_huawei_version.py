from analyzer.src.utils.dict_to_list_and_sort import dictToListAndSortAndZip, versionSortingKey
from config import *
from collections import defaultdict

def analyzeHuaweiVersion(cveList):
	se = set()
	key = 'affectedHuaweiVersions'
	cnt = 0

	productsVerMapToCnt = defaultdict(lambda: defaultdict(int))
	for cveDict in cveList:
		if cveDict[key]:
			cnt += 1
			prodVers = cveDict[key]
			for prodVer in prodVers:
				for pv in re.findall(emuiPattern, prodVer):
					if pv[huaweiProductIndex]:
							productsVerMapToCnt[pv[huaweiProductIndex]][pv[huaweiVersionIndex]] += 1
				for pv in re.findall(magicUiPattern, prodVer):
					if pv[huaweiProductIndex]:
						productsVerMapToCnt[pv[huaweiProductIndex]][pv[huaweiVersionIndex]] += 1

	for k, v in productsVerMapToCnt.items():
		productsVerMapToCnt[k] = dictToListAndSortAndZip(v, key=versionSortingKey)
	return {'countOfCveThatAffectHuaweiProducts': cnt, 'data': productsVerMapToCnt}
