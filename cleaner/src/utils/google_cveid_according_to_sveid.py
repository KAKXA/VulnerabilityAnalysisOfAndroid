from config import *
from collections import defaultdict
from cleaner.src.utils.column_map import columnMap
from scraper.src.get_cve_details import getOneCveDetail
from scraper.src.utils.get_html import getHtml

def googleCveIdAccordingToSveId(sveId):
    url = 'https://www.google.com/search?q=' + sveId + '+site%3Acvedetails.com'
    localPath = os.path.join(googleSearchDirectory, sveId + '.html')
    html = getHtml(url, localPath)
    while re.search('unusual traffic', html):
        html = getHtml(url, localPath, 'rewrite')

    dic = defaultdict(int)
    for i in re.findall(r'CVE-\d{4}-\d*', html):
        dic[i] += 1
    if dic:
        maxK, maxV = 0, 0
        for k, v in dic.items():
            if v > maxV:
                maxK = k
                maxV = v
        detail = getOneCveDetail(maxK)
        if detail:
            detailAfterColumnMap = columnMap('cveDetailsJson', detail)
            if detailAfterColumnMap['sveId'] == sveId:
                return detailAfterColumnMap