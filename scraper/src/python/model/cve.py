import re
import logging
from ..config import *
from ..exception.cve_exception import *
from ..utils.convertor import str2Date
from ..utils.decorator import noneCheck

class CVE:

    # class variable
    _sections = set()
    _components = set()

    def __init__(self):
        # these are non-nullable val
        # self.cveId
        # self.date
        # self.securityPatchLevel
        # self.section

        # these are nullable var
        self._references = []
        self._type = None
        self._severity = None
        self._updatedAospVersions = set()
        self._component = None

    @noneCheck
    def setCveId(self, cveId: str):
        pattern = re.fullmatch('[c|C][v|V][e|E]-[0-9]{4}-[0-9]*', cveId)
        if pattern:
            self._cveId = cveId.upper()
        else:
            raise WrongPatternError('cveId')
    
    def getCveId(self):
        return self._cveId

    @noneCheck
    def setPublishDate(self, publishDate):
        try:
            if isinstance(publishDate, str):
                publishDate = str2Date(publishDate)
            self._publishDate = publishDate
        except:
            raise WrongPatternError('publishDate')
    
    def getPublishDate(self):
        return self._publishDate

    @noneCheck
    def setSecurityPatchLevel(self, securityPatchLevel: str):
        pattern = re.fullmatch('\d{4}-\d{1,2}-\d{1,2}', securityPatchLevel)
        if (pattern == None):
            raise WrongPatternError('securityPatchLevel')
        else:
            self._securityPatchLevel = securityPatchLevel
    
    def getSecurityPatchLevel(self):
        return self._securityPatchLevel

    @noneCheck
    def setReferences(self, references: list):
        # references
        # [
        #   ['A-123': None],
        #   ['QC-123': 'a.com'],
        # ]
        for ref, refUrl in references:
            belong = ref.split('-')[0].upper()
            if belong in referencePrefix:
                self._references.append([belong, refUrl])
            else:
                raise WrongPatternError('ref')
    
    def getReferences(self):
        return self._references

    @noneCheck
    def setType(self, type: str):
        if type.upper() == 'N/A':
            self._type = None
        elif type.upper() in types:
            self._type = type.upper()
        else:
            raise WrongPatternError('type')
        
    def getType(self):
        return self._type

    @noneCheck
    def setSeverity(self, severity: str):
        if severity.upper() in severities:
            self._severity = severity.upper()
        else:
            raise WrongPatternError('severity')
    
    def getSeverity(self):
        return self._severity

    @noneCheck
    def setUpdatedAospVersions(self, aosp: str):
        aospArr = re.split(', *', aosp)
        for version in aospArr:
            match = False
            versionUpper = version.upper()
            for aospVersionPattern, splitPattern in aospVersionPatternsAndSplitPatterns:
                if re.fullmatch(aospVersionPattern, versionUpper):
                    for versionAfterSplit in versionUpper.split(splitPattern):
                        self._updatedAospVersions.add(versionAfterSplit)
                    match = True
                    break
            if not match:
                raise WrongPatternError('aosp')
    
    def getUpdatedAospVersions(self):
        return self._updatedAospVersions

    @noneCheck
    def setSection(self, section: str):
        CVE._sections.add(section.upper())
        self._section = section.upper()
    
    def getSection(self):
        return self._section

    def getAllSections():
        return CVE._sections

    @noneCheck
    def setComponent(self, component: str):
        self._component = component.upper()
        CVE._components.add(component.upper())

    def getComponent(self):
        return self._component
    
    def getAllComponents():
        return CVE._components
      