import re
from typing import Iterable
from attr import attrs
from bs4 import BeautifulSoup
from scraper.src.exception.get_cve_list_exception import SubHtmlNotFoundError

def str2Pat(s: str) -> str:
    for c in ['\\', '*','.','?','+','$','^', '[',']','(',')','{','}','|','/']:
        s = s.replace(c, '\\' + c)
    return s

def getHeadersAndSubHtmls(headTag: str, html: str, pattern='.*') -> Iterable:
    bs = BeautifulSoup(html, 'lxml')
    headers = []
    subHtmls = []
    tmpHeaders = bs.find_all(headTag, attrs=attrs)
    for i, header in enumerate(tmpHeaders):
        if not re.search(pattern, str(header)):
            continue
        headers.append(header)
        if i + 1 != len(tmpHeaders):
            pat = str2Pat(str(header.getText())) + '.*' + str2Pat(str(tmpHeaders[i + 1].getText()))
        else:
            pat = str2Pat(str(header.getText())) + '.*$'
        subHtml = re.search(pat, html, re.S)
        if subHtml == None:
            raise SubHtmlNotFoundError('pat')
        subHtmls.append(subHtml.group())
    
    return list(zip(headers, subHtmls))